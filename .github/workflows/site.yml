name: Scrape Build Deploy

on:
  schedule:
    - cron: "3,33 6,7,18,19 * * *"  # Denver midnight/noon across DST & Standard
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  SUMMARIZER_MODEL: gpt-4o-mini
  PDF_SUMMARY_MAX_PAGES: '30'
  PDF_SUMMARY_MAX_CHARS: '72000'
  PDF_SUMMARY_MAX_BULLETS: '16'
  PDF_SUMMARY_DEBUG: '1'
  
concurrency:
  group: daily-${{ github.ref }}
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-24.04
    outputs:
      should_run: ${{ steps.guard.outputs.continue }}
    env:
      SALIDA_CIVICCLERK_URL: https://salidaco.portal.civicclerk.com
      SALIDA_CIVICCLERK_ALT_HOSTS: https://salidaco.portal.civicclerk.com,https://salidaco.civicclerk.com,https://cityofsalida.civicclerk.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Cron heartbeat
        run: |
          echo "event=${{ github.event_name }}"
          echo "utc=$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "denver=$(TZ=America/Denver date '+%Y-%m-%d %H:%M:%S %Z')"
        
      - name: "Guard ‚Äî only run at midnight/noon America/Denver"
        if: ${{ github.event_name == 'schedule' }}
        id: guard
        shell: bash
        run: |
          HOUR="$(TZ=America/Denver date +%H)"
          echo "Local hour is $HOUR"
          if [ "$HOUR" = "00" ] || [ "$HOUR" = "12" ]; then
            echo "continue=true" >> "$GITHUB_OUTPUT"
          else
            echo "continue=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f scraper/requirements.txt ]; then
            pip install -r scraper/requirements.txt
          else
            echo "requirements.txt not found" && exit 1
          fi
          
      - name: Install Playwright browsers
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        run: python -m playwright install --with-deps chromium    

      - name: Print effective PDF limits
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        run: |
          python - <<'PY'
          import os
          from scraper.utils import _MAX_BULLETS, _DEFAULT_MAX_PAGES, _DEFAULT_MAX_CHARS
          print("ENV.PDF_SUMMARY_MAX_BULLETS =", os.getenv("PDF_SUMMARY_MAX_BULLETS"))
          print("ENV.PDF_SUMMARY_MAX_PAGES   =", os.getenv("PDF_SUMMARY_MAX_PAGES"))
          print("ENV.PDF_SUMMARY_MAX_CHARS   =", os.getenv("PDF_SUMMARY_MAX_CHARS"))
          print("utils._MAX_BULLETS          =", _MAX_BULLETS)
          print("utils._DEFAULT_MAX_PAGES    =", _DEFAULT_MAX_PAGES)
          print("utils._DEFAULT_MAX_CHARS    =", _DEFAULT_MAX_CHARS)
          PY

      - name: Clear agenda summary cache
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        run: rm -rf data/cache/agenda_summaries || true
        
      - name: Debug hosts
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        run: |
          echo "SALIDA_CIVICCLERK_URL=${SALIDA_CIVICCLERK_URL}"
          echo "SALIDA_CIVICCLERK_ALT_HOSTS=${SALIDA_CIVICCLERK_ALT_HOSTS}"  

      - name: Run scraper
        env:
          DEBUG: "1"
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        run: |
          python -m scraper.main
          test -d data && ls -la data || (echo "no data dir generated" && exit 1)
      # --- Summarize agendas (this generates the bullets) ---
      - name: Summarize agendas (GPT)
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUMMARIZER_MODEL: ${{ env.SUMMARIZER_MODEL }}
          PDF_SUMMARY_DEBUG: '1'
        run: |
          set -euxo pipefail
          python -m scraper.summarize --input data/meetings.json --out data/cache/agenda_summaries

          echo "---- agenda_summaries (ls) ----"
          ls -la data/cache/agenda_summaries || true

          echo "---- any meta errors ----"
          (grep -Hn '"error"' data/cache/agenda_summaries/*.meta.json || true)

          echo "---- sample meta ----"
          head -n 80 $(ls data/cache/agenda_summaries/*.meta.json | head -n1) || true

      - name: "Sanity check: did we produce any bullets?"
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          metas=(data/cache/agenda_summaries/*.meta.json)
          if [ ${#metas[@]} -eq 0 ]; then
            echo "No meta files found in data/cache/agenda_summaries"
            exit 1
          fi
          # Count items that either have non-empty bullets OR explicit merged>0 (future-proof)
          n=$(jq -s '[.[] 
            | select((.ok==true) and ( ((.merged? // 0) | tonumber) > 0 or ((.bullets // []) | length) > 0 ))
          ] | length' "${metas[@]}")
          echo "Summaries with bullets (or merged): ${n}"
          test "${n}" -gt 0

      - name: Upload data artifact (data/)
        if: ${{ github.event_name != 'schedule' || steps.guard.outputs.continue == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: scrape-data
          path: data/

  build:
    runs-on: ubuntu-latest
    needs: scrape
    if: ${{ github.event_name != 'schedule' || needs.scrape.outputs.should_run == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download scrape data
        uses: actions/download-artifact@v4
        with:
          name: scrape-data
          path: ./data

      - name: Prepare static site
        run: |
          mkdir -p _site
          cp -r data _site/
          
      - name: Add demo.html to published site
        run: |
          cp demo.html _site/demo.html

      - name: Generate index.html from data/meetings.json
        run: |
          python - <<'PY'
          import json, html
          from pathlib import Path
          
          data_path = Path("data/meetings.json")
          out_dir   = Path("_site")
          (out_dir/"data").mkdir(parents=True, exist_ok=True)
          
          # Copy meetings.json into the public _site/data folder
          out_data_path = out_dir / "data" / "meetings.json"
          out_data_path.write_text(data_path.read_text(encoding="utf-8"), encoding="utf-8")
          
          # Load meetings for the static (no-JS) fallback
          try:
              raw = json.loads(data_path.read_text(encoding='utf-8'))
          except FileNotFoundError:
              (out_dir/'index.html').write_text(
                  "<h1>MeetingWatch</h1><p>No meetings.json found.</p>", encoding='utf-8'
              )
              raise
          
          # meetings may be a list or wrapped (e.g., {"meetings":[...]})
          if isinstance(raw, list):
              meetings = raw
          else:
              meetings = raw.get('meetings') or next((v for v in raw.values() if isinstance(v, list)), [])
          
          def sort_key(m):
              d = (m.get('date') or '')
              t = m.get('start_time_local') or m.get('start_time') or m.get('time') or ''
              return (d, t)
          
          meetings = sorted(meetings, key=sort_key)
          
          # ---------- HTML skeleton ----------
          parts = []
          parts.append('<!doctype html><meta charset="utf-8"><title>MeetingWatch</title>')
          parts.append('''<style>
            body{font:16px system-ui,Segoe UI,Helvetica,Arial;max-width:900px;margin:2rem auto;padding:0 1rem;}
            h1{margin:0 0 1rem;}
            .m{border:1px solid #e3e3e3;border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04);}
            .meta{color:#555;font-size:.95rem}
            ul{margin:.5rem 0 0 1.3rem}
            a{color:#0b62d6;text-decoration:none}
            a:hover{text-decoration:underline}
            #controls{display:grid;gap:.5rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin:1rem 0;}
            #controls label select{width:100%;padding:.4rem;border-radius:.5rem;border:1px solid #e5e7eb}
            #results{list-style:none;padding:0;display:grid;gap:.75rem;}
          </style>''')
          
          parts.append('<h1>MeetingWatch</h1>')
          parts.append('<p><a href="data/meetings.json">Download meetings.json</a></p>')
          
          # Controls + dynamic target
          parts.append('''
            <section id="controls">
              <label><div style="font-weight:600;">City</div>
                <select id="citySelect"><option value="">All cities</option></select>
              </label>
              <label><div style="font-weight:600;">Source</div>
                <select id="sourceSelect"><option value="">All sources</option></select>
              </label>
            </section>
            <ul id="results"></ul>
          ''')
          
          # ---------- Static fallback (kept for no-JS) ----------
          parts.append('<noscript><p><em>JavaScript disabled ‚Äî showing unfiltered list.</em></p></noscript>')
          parts.append('<div id="static-list">')
          
          for m in meetings:
              title = html.escape(m.get('title') or m.get('name') or 'Meeting')
              date  = html.escape(m.get('date') or '')
              # keep your previous time fallbacks
              time  = html.escape(m.get('start_time_local') or m.get('start_time') or m.get('time') or '')
              loc   = html.escape(m.get('location') or '')
              agenda_url = m.get('agenda_url') or m.get('agenda_pdf') or ''
              agenda_link = f' &middot; <a href="{html.escape(agenda_url)}">agenda</a>' if agenda_url else ''
              source_url = m.get('source') or ''
              source_link = f' &middot; <a href="{html.escape(source_url)}">{html.escape(source_url)}</a>' if source_url else ''
          
              bullets = m.get('agenda_summary') or []
              if isinstance(bullets, str):
                  bullets = [bullets]
              bullets = [html.escape(str(b)) for b in bullets]
          
              parts.append('<div class="m">')
              parts.append(f'<div class="meta"><strong>{date}</strong> {time}{agenda_link}{source_link}</div>')
              parts.append(f'<h3 style="margin:.35rem 0 .4rem">{title}</h3>')
              if loc:
                  parts.append(f'<div class="meta">{loc}</div>')
              if bullets:
                  parts.append('<ul>')
                  for b in bullets:
                      parts.append(f'<li>{b}</li>')
                  parts.append('</ul>')
              parts.append('</div>')
          
          parts.append('</div>')  # /#static-list
          
          # ---------- Client-side filters + uniform card header ----------
          parts.append('''<script>
          (async function(){
            const res = await fetch('data/meetings.json', {cache:'no-store'});
            const raw = await res.json();
            const items = Array.isArray(raw) ? raw : (raw.meetings || []);

            // Sort by date and time to ensure chronological order
            items.sort((a, b) => {
              const dateA = a.date || '';
              const timeA = a.start_time_local || a.start_time || a.time || '';
              const dateB = b.date || '';
              const timeB = b.start_time_local || b.start_time || b.time || '';
            
              if (dateA < dateB) return -1;
              if (dateA > dateB) return 1;
              if (timeA < timeB) return -1;
              if (timeA > timeB) return 1;
              return 0;
            });
          
            const citySel = document.getElementById('citySelect');
            const srcSel  = document.getElementById('sourceSelect');
            const results = document.getElementById('results');
            const staticList = document.getElementById('static-list');
          
            // --- Always show these cities, even if they have (0) meetings right now ---
            const KNOWN_CITIES = [
              "Alamosa",
              "Colorado Springs",
              "Salida",
              "Pueblo",
              "El Paso County",
              "Trinidad"
            ];
            
            // Counts from current data (for badges)
            const cityCounts = items.reduce((acc, x) => {
              const c = (x.city || '').trim();
              if (!c) return acc;
              acc[c] = (acc[c] || 0) + 1;
              return acc;
            }, {});
            
            // Merge catalog ‚à™ data, then sort alphabetically
            const cities = Array.from(new Set([
              ...KNOWN_CITIES,
              ...Object.keys(cityCounts)
            ])).sort();
            
            // Build options with counts; keep selectable even if 0
            for (const c of cities) {
              const count = cityCounts[c] || 0;
              citySel.append(new Option(`${c} (${count})`, c));
            }
            
            // Sources unchanged (built from data only)
            const sources = [...new Set(items.map(x => (x.provider||'').trim()).filter(Boolean))].sort();
            for (const s of sources) srcSel.append(new Option(s, s));

          
            // Restore from URL/localStorage
            const url = new URL(location.href);
            citySel.value = url.searchParams.get('city') ?? localStorage.getItem('mw_city') ?? '';
            srcSel.value  = url.searchParams.get('source') ?? localStorage.getItem('mw_source') ?? '';
          
            function inferType(title=''){
              const t = String(title).toLowerCase();
              if (t.includes('work'))   return 'Work Session';
              if (t.includes('special'))return 'Special Meeting';
              if (t.includes('regular'))return 'City Council Regular Meeting';
              if (t.includes('council'))return 'City Council Meeting';
              return 'Meeting';
            }
            function formatWhen(m){
              const d = m.date || '';
              const t = m.start_time_local || m.start_time || m.time || '';
              const tz = m.tz ? (' ' + String(m.tz).replace('America/','')) : '';
              if (d && t) return d + ' ‚Ä¢ ' + t + tz;
              if (d) return d;
              if (t) return t + tz;
              return '';
            }
            function headerLine(m){
              const city = m.city ? 'üèôÔ∏è ' + m.city : '';
              const agenda = (m.agenda_url || m.agenda_pdf) ? '<a href="'+(m.agenda_url||m.agenda_pdf)+'" target="_blank" rel="noopener">üìù Agenda</a>' : '';
              const source = m.source ? '<a href="'+m.source+'" target="_blank" rel="noopener">üåê Source</a>' : '';
              const type = 'üìå ' + (m.meeting_type || inferType(m.title||''));
              const when = (function(w){ return w ? 'üïí ' + w : ''; })(formatWhen(m));
              return [city, agenda, source, type, when].filter(Boolean).join('  ‚Ä¢  ');
            }
            function bulletsHTML(m){
              const arr = Array.isArray(m.agenda_summary) ? m.agenda_summary
                         : (typeof m.agenda_summary === 'string' ? m.agenda_summary.split(/\\n+/).filter(Boolean) : []);
              if (!arr.length) return '';
              return '<ul>' + arr.map(b => '<li>'+b+'</li>').join('') + '</ul>';
            }
            function syncState(){
              const c = citySel.value, s = srcSel.value;
              localStorage.setItem('mw_city', c);
              localStorage.setItem('mw_source', s);
              const u = new URL(location.href);
              c ? u.searchParams.set('city', c) : u.searchParams.delete('city');
              s ? u.searchParams.set('source', s) : u.searchParams.delete('source');
              history.replaceState({}, '', u);
            }
            function render(){
              syncState();
              const c = citySel.value, s = srcSel.value;
              const filtered = items.filter(m =>
                (!c || (m.city||'') === c) && (!s || (m.provider||'') === s)
              );
              results.innerHTML = '';
              if (!filtered.length){
                results.innerHTML = '<li style="opacity:.75;">No results match your filters.</li>';
                staticList.style.display = '';
                return;
              }
              // Hide the static fallback once we have dynamic content
              staticList.style.display = 'none';
          
              for (const m of filtered){
                const href = m.url || m.source || m.agenda_url || '#';
                const li = document.createElement('li');
                li.className = 'm';
                li.innerHTML = `
                  <div style="font-weight:700;margin-bottom:.25rem;">
                    <a href="${href}" target="_blank" rel="noopener">${(m.title||'Meeting')}</a>
                  </div>
                  <div class="meta" style="margin-bottom:.4rem;display:flex;flex-wrap:wrap;gap:.5rem .75rem;">
                    ${headerLine(m)}
                  </div>
                  ${bulletsHTML(m)}
                `;
                results.appendChild(li);
              }
            }
            citySel.addEventListener('change', render);
            srcSel.addEventListener('change', render);
            render();
          })();
          </script>''')
          
          (out_dir/'index.html').write_text('\n'.join(parts), encoding='utf-8')
          PY


      - name: List built site (debug)
        run: |
          echo "Built site contents:"
          find _site -maxdepth 3 -type f -print

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    if: ${{ github.event_name != 'schedule' || needs.scrape.outputs.should_run == 'true' }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
