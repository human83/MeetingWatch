<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meeting Watch</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background:#0b1020; color:#eef1f7; }
    header { padding: 1rem 1.25rem; border-bottom: 1px solid #223; background: #0f1530; position: sticky; top: 0; }
    h1 { margin: 0; font-size: 1.25rem; }
    .wrap { max-width: 1000px; margin: 1rem auto; padding: 0 1rem; }
    .group { margin: 1.5rem 0; }
    .card { background: #121938; border: 1px solid #223; border-radius: 14px; padding: 1rem; margin: 0.75rem 0; box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
    .meta { font-size: 0.95rem; opacity: 0.9; }
    .chips { display: flex; flex-wrap: wrap; gap: .5rem; margin-top: .35rem; }
    .chip { background: #1c264b; border: 1px solid #2a386a; border-radius: 20px; padding: .15rem .6rem; font-size: .8rem; }
    .bullets { margin: .5rem 0 0 .5rem; }
    a { color: #91b6ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .small { font-size: .85rem; opacity: .8; }
    .jur { font-weight: bold; font-size: 1.1rem; }
    .empty { opacity: .7; font-style: italic; }
  </style>
</head>
<body>
  <header>
    <h1>Meeting Watch — Future Meetings</h1>
    <div class="small">Auto-updated by scheduled scrapes. Times shown in America/Denver.</div>
  </header>

  <div class="wrap">
    <div id="lastChecked" class="small"></div>
    <div id="content"></div>
  </div>

  <script>
    function safeText(v) {
      return (v ?? '').toString();
    }

    function parseDateTime(m) {
      // Expect ISO-like date in m.date (YYYY-MM-DD) and a human time string
      const d = safeText(m.date);
      const t = safeText(m.start_time_local || m.time_local || '');
      // Sort key: YYYY-MM-DD + HH:MM AM/PM converted to 24h if present
      let sortKey = d;
      if (t) {
        const mt = t.match(/^(\d{1,2}):(\d{2})\s*([AP]M)$/i);
        if (mt) {
          let hh = parseInt(mt[1], 10);
          const mm = mt[2];
          const ap = mt[3].toUpperCase();
          if (ap === 'PM' && hh !== 12) hh += 12;
          if (ap === 'AM' && hh === 12) hh = 0;
          sortKey += ' ' + String(hh).padStart(2, '0') + ':' + mm;
        } else {
          // Unknown time format -> push after known times but keep stable
          sortKey += ' 99:99';
        }
      } else {
        // No time -> sort to the end of the day
        sortKey += ' 99:99';
      }
      return sortKey;
    }

    function displayTime(m) {
      // Prefer start_time_local from scraper (or time_local legacy)
      return safeText(m.start_time_local || m.time_local || 'Time TBD');
    }

    async function load() {
      // IMPORTANT: correct relative path for GitHub Pages when hosted at /MeetingWatch
      const res = await fetch('data/meetings.json', { cache: 'no-store' });
      if (!res.ok) {
        document.getElementById('content').textContent = 'Failed to load meetings.json';
        return;
      }
      const data = await res.json();

      document.getElementById('lastChecked').textContent =
        'Last checked (MT): ' + safeText(data.last_checked_mt);

      // Group by city/body and sort meetings inside each group by date/time
      const groups = {};
      for (const m of (data.meetings || [])) {
        const key = m.city_or_body || m.jurisdiction || 'Unknown';
        if (!groups[key]) groups[key] = [];
        groups[key].push(m);
      }

      const container = document.getElementById('content');
      container.innerHTML = '';

      const sortedKeys = Object.keys(groups).sort();
      for (const k of sortedKeys) {
        const list = groups[k].slice().sort((a,b) => {
          const ka = parseDateTime(a);
          const kb = parseDateTime(b);
          return ka.localeCompare(kb);
        });

        const gDiv = document.createElement('div');
        gDiv.className = 'group';

        const h = document.createElement('div');
        h.className = 'jur';
        h.textContent = k;
        gDiv.appendChild(h);

        for (const m of list) {
          const c = document.createElement('div');
          c.className = 'card';

          // Title: DATE — TIME — TYPE
          const title = document.createElement('div');
          const when = `${safeText(m.date)} — ${displayTime(m)} — ${safeText(m.meeting_type)}`;
          title.innerHTML = `<strong>${when}</strong>`;
          c.appendChild(title);

          // Meta: location
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = safeText(m.location || 'Location not listed');
          c.appendChild(meta);

          // Chips: status, agenda link (if any)
          const chips = document.createElement('div');
          chips.className = 'chips';

          if (m.status) {
            const status = document.createElement('span');
            status.className = 'chip';
            status.textContent = m.status;
            chips.appendChild(status);
          }

          if (m.agenda_url) {
            const linkChip = document.createElement('span');
            linkChip.className = 'chip';
            const a = document.createElement('a');
            a.href = m.agenda_url;
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = 'Agenda';
            linkChip.appendChild(a);
            chips.appendChild(linkChip);
          }

          c.appendChild(chips);

          // Agenda summary
          const summary = document.createElement('div');
          summary.className = 'bullets';

          if (Array.isArray(m.agenda_summary) && m.agenda_summary.length) {
            const ul = document.createElement('ul');
            for (const s of m.agenda_summary) {
              const li = document.createElement('li');
              li.textContent = safeText(s);
              ul.appendChild(li);
            }
            summary.appendChild(ul);
          } else if (typeof m.agenda_summary === 'string' && m.agenda_summary.trim()) {
            summary.textContent = m.agenda_summary;
          } else {
            summary.innerHTML = '<span class="empty">Agenda not posted yet</span>';
          }

          c.appendChild(summary);
          gDiv.appendChild(c);
        }

        container.appendChild(gDiv);
      }
    }

    load();
  </script>
</body>
</html>
